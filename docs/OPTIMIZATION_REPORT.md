# üöÄ –û—Ç—á–µ—Ç –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤

## –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

#### 1. **–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç** (`prompt_optimized.md`)
**–≠–∫–æ–Ω–æ–º–∏—è: ~60% —Ç–æ–∫–µ–Ω–æ–≤**

| –ú–µ—Ç—Ä–∏–∫–∞ | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –≠–∫–æ–Ω–æ–º–∏—è |
|---------|------|-------|----------|
| –°—Ç—Ä–æ–∫ | 22 | 25 | - |
| –¢–æ–∫–µ–Ω–æ–≤ (–ø—Ä–∏–º–µ—Ä–Ω–æ) | ~380 | ~150 | ~230 |

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚ùå –£–±—Ä–∞–Ω—ã —ç–º–æ–¥–∑–∏ (‚Üí ASCII —Å–∏–º–≤–æ–ª—ã: +, -, ?)
- ‚úÇÔ∏è –°–æ–∫—Ä–∞—â–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ñ—Ä–∞–∑—ã
- üì¶ –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π
- ‚û°Ô∏è –°—Ç—Ä–µ–ª–∫–∏ –≤–º–µ—Å—Ç–æ –¥–ª–∏–Ω–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π
- üéØ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

#### 2. **–û–ø–∏—Å–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤** (`tool_analyzer.py`)
**–≠–∫–æ–Ω–æ–º–∏—è: ~40% —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ–ø–∏—Å–∞–Ω–∏—è—Ö**

**–ü—Ä–∏–º–µ—Ä—ã —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π:**
```
–ë—ã–ª–æ: "–ß–¢–ï–ù–ò–ï –§–ê–ô–õ–û–í"
–°—Ç–∞–ª–æ: "–ß–¢–ï–ù–ò–ï"

–ë—ã–ª–æ: "–ß–∏—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞"
–°—Ç–∞–ª–æ: "–ß–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª"

–ë—ã–ª–æ: "–°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∞–π–ª"
–°—Ç–∞–ª–æ: "–ü–∏—à–µ—Ç —Ñ–∞–π–ª"
```

#### 3. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–æ–≤** (`agent.py`)
**–≠–∫–æ–Ω–æ–º–∏—è: ~70% —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ**

**–ë—ã–ª–æ:**
```
–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: '/path/to/dir'

–ó–ê–î–ê–ß–ê: –í—ã–ø–æ–ª–Ω–∏ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞—è –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.

–ò–ó–í–ï–°–¢–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò: user1, user2
–ü–û–°–õ–ï–î–ù–ò–ô –ß–ê–¢: 12345

–ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: —Å–æ–∑–¥–∞–π —Ñ–∞–π–ª
```

**–°—Ç–∞–ª–æ:**
```
DIR: /path/to/dir | USERS: user1, user2 | CHAT: 12345 | —Å–æ–∑–¥–∞–π —Ñ–∞–π–ª
```

#### 4. **–°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö**
**–≠–∫–æ–Ω–æ–º–∏—è: ~75% —Ç–æ–∫–µ–Ω–æ–≤**

**–ü—Ä–∏–º–µ—Ä—ã:**
```
–ë—ã–ª–æ: "üòî **–ü—Ä–µ–≤—ã—à–µ–Ω—ã –ª–∏–º–∏—Ç—ã API Google Gemini (–æ—à–∏–±–∫–∞ 429)**\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω–æ 60 —Å–µ–∫—É–Ω–¥..."
–°—Ç–∞–ª–æ: "Rate limit (429). –ü–æ–¥–æ–∂–¥–∏—Ç–µ 60 —Å–µ–∫—É–Ω–¥."

–ë—ã–ª–æ: "üîÑ **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ**\n\n–ü—Ä–∏—á–∏–Ω–∞: –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ...\n\nüí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**..."
–°—Ç–∞–ª–æ: "Stopped: –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ\nFix: rephrase | disable tool | /continue"
```

---

## üìä –û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤

### –†–∞—Å—á–µ—Ç –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ —Ç–∏–ø–∏—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–æ–∫–µ–Ω–æ–≤ (–±—ã–ª–æ) | –¢–æ–∫–µ–Ω–æ–≤ (—Å—Ç–∞–ª–æ) | –≠–∫–æ–Ω–æ–º–∏—è |
|-----------|----------------|-----------------|----------|
| –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç | ~380 | ~150 | 60% |
| –û–ø–∏—Å–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (10 —à—Ç) | ~500 | ~300 | 40% |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ | ~100 | ~30 | 70% |
| –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö | ~200 | ~50 | 75% |
| **–ò–¢–û–ì–û –Ω–∞ –∑–∞–ø—Ä–æ—Å** | **~1180** | **~530** | **~55%** |

### –ì–æ–¥–æ–≤–∞—è —ç–∫–æ–Ω–æ–º–∏—è (–ø—Ä–∏ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å):

- **–¢–æ–∫–µ–Ω–æ–≤ –≤ –¥–µ–Ω—å:** 650,000 ‚Üí 530,000 = **650,000 —ç–∫–æ–Ω–æ–º–∏—è**
- **–¢–æ–∫–µ–Ω–æ–≤ –≤ –≥–æ–¥:** ~237M ‚Üí ~107M = **~130M —ç–∫–æ–Ω–æ–º–∏—è**
- **–°—Ç–æ–∏–º–æ—Å—Ç—å (Gemini Flash $0.075/1M input):** ~$17.77 ‚Üí ~$8.03 = **~$9.74/–≥–æ–¥ —ç–∫–æ–Ω–æ–º–∏—è**

---

## üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤** (Gemini 1.5+)
Gemini 1.5 Pro/Flash –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Context Caching, —á—Ç–æ –º–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞ 75%:

```python
# –í agent.py –¥–æ–±–∞–≤–∏—Ç—å
from google.generativeai import caching

# –ó–∞–∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + –æ–ø–∏—Å–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
cache = caching.CachedContent.create(
    model="gemini-1.5-flash",
    system_instruction=system_prompt,
    ttl="3600s"  # 1 —á–∞—Å
)
```

**–≠–∫–æ–Ω–æ–º–∏—è:** –¥–æ 75% –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–∞—Ö

### 2. **–£–º–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤**

–î–æ–±–∞–≤–∏—Ç—å –≤ `tool_analyzer.py`:

```python
def generate_tools_description(self, max_length: int = 100) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –¥–ª–∏–Ω—ã –æ–ø–∏—Å–∞–Ω–∏–π"""
    # –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    # –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~20-30% –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

### 3. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤**

–ó–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:

```python
# –í–º–µ—Å—Ç–æ –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å—Ä–∞–∑—É
relevant_tools = self.select_relevant_tools(user_input)
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~40-60% –Ω–∞ –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–∞—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

### 4. **–ö–æ–º–ø—Ä–µ—Å—Å–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏**

–í `context_manager.py` –¥–æ–±–∞–≤–∏—Ç—å —Å–∂–∞—Ç–∏–µ:

```python
def compress_history(self) -> str:
    """–°–∂–∞—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤"""
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ—Ö–æ–∂–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    # –£–±–∏—Ä–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
```

**–≠–∫–æ–Ω–æ–º–∏—è:** ~30-40% –Ω–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏—è—Ö

### 5. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –º–æ–¥–µ–ª–∏**

- **Gemini Flash 2.0** ‚Äî –±—ã—Å—Ç—Ä–µ–µ –∏ –¥–µ—à–µ–≤–ª–µ
- **Gemini Flash 8B** ‚Äî –µ—â—ë –¥–µ—à–µ–≤–ª–µ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á

```json
// config.json
{
  "agent": {
    "model_name": "gemini-2.0-flash-exp",  // –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å
    "model_provider": "gemini"
  }
}
```

**–≠–∫–æ–Ω–æ–º–∏—è:** –¥–æ 10x –ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç:

```json
{
  "agent": {
    "model_name": "gemini-2.0-flash-exp",
    "temperature": 0.1,
    "use_memory": true,
    "max_context_files": 10
  },
  "files": {
    "prompt_file": "prompt_optimized.md"
  }
}
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
# .env
GEMINI_MODEL=gemini-2.0-flash-exp
TEMPERATURE=0.1
```

---

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è

### –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–¥ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤:

```python
# –í agent.py
def process_message(self, user_input: str):
    # –ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤
    input_tokens = count_tokens(user_input)
    output_tokens = count_tokens(response)
    
    logger.info(f"Tokens: {input_tokens} in, {output_tokens} out")
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    self.context_manager.add_token_stats(input_tokens, output_tokens)
```

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

- [x] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
- [x] –°–æ–∫—Ä–∞—â–µ–Ω—ã –æ–ø–∏—Å–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- [x] –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- [x] –ö–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- [ ] –í–Ω–µ–¥—Ä–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤
- [ ] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- [ ] –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤

---

## üéì –ò—Ç–æ–≥–∏

### –î–æ—Å—Ç–∏–≥–Ω—É—Ç–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: **~55% —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤**

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º:

1. **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
   - ‚¨ú –í–∫–ª—é—á–µ–Ω–∏–µ Context Caching (Gemini 1.5+)
   - ‚¨ú –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Gemini Flash 2.0

2. **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
   - ‚¨ú –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
   - ‚¨ú –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–æ–∫–µ–Ω–æ–≤

3. **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
   - ‚¨ú –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –∏—Å—Ç–æ—Ä–∏–∏
   - ‚¨ú –£–º–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏–π

---

**–î–∞—Ç–∞:** 2025-11-03  
**–í–µ—Ä—Å–∏—è –∞–≥–µ–Ω—Ç–∞:** v4.0-optimized

